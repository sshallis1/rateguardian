import type { VercelRequest, VercelResponse } from "@vercel/node";
import { createClient } from "@supabase/supabase-js";
import type { Database } from "../types/supabase";

// ────────────────────────────────────────────────
// Initialize Supabase (Typed) - same pattern as /api/intake
// ────────────────────────────────────────────────
const supabaseUrl = process.env.SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

const supabase = supabaseUrl && supabaseServiceKey
  ? createClient<Database>(supabaseUrl, supabaseServiceKey, {
      auth: { persistSession: false },
    })
  : null;

// ────────────────────────────────────────────────
//  /api/test-engine (V8 Health Check Endpoint)
// ────────────────────────────────────────────────
export default async function handler(req: VercelRequest, res: VercelResponse) {
  try {
    if (req.method !== "GET") {
      return res.status(405).json({ error: "Method Not Allowed" });
    }

    // Basic env check
    if (!supabaseUrl || !supabaseServiceKey) {
      return res.status(500).json({
        engine: "unhealthy",
        error: "Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY",
      });
    }

    if (!supabase) {
      return res.status(500).json({
        engine: "unhealthy",
        error: "Supabase client not initialized",
      });
    }

    // ──────────────────────────────────────────
    // 1) Simple contacts read (sanity check)
    // ──────────────────────────────────────────
    const {
      data: contactsSample,
      error: contactsError,
    } = await supabase
      .from("contacts")
      .select("id, email, name")
      .limit(1);

    // ──────────────────────────────────────────
    // 2) Latest run_ledger row (if table exists)
    // ──────────────────────────────────────────
    let latestRun = null;
    let runError = null;

    try {
      const { data, error } = await supabase
        .from("rg_run_ledger")
        .select("*")
        .order("started_at", { ascending: false })
        .limit(1);

      if (error) {
        runError = error;
      } else {
        latestRun = data?.[0] ?? null;
      }
    } catch (err: any) {
      // If table doesn't exist or query fails, keep it non-fatal
      runError = err?.message || String(err);
    }

    // Build overall health status
    const supabaseHealthy = !contactsError;

    return res.status(200).json({
      engine: "healthy-stub", // V8: routing + basic DB check
      supabase: supabaseHealthy ? "connected" : "error",
      supabase_error: contactsError || null,
      sample_contact: contactsSample?.[0] || null,
      latest_run_ledger: latestRun,
      run_ledger_error: runError,
      timestamp: new Date().toISOString(),
    });

  } catch (err: any) {
    console.error("Unhandled /api/test-engine error:", err);
    return res.status(500).json({
      engine: "unhealthy",
      error: "Unexpected server error",
      details: err?.message || err,
    });
  }
}
